pipeline {
    agent any

    environment {
        // --- AWS 계정 및 리전 정보 ---
        AWS_REGION = 'ap-northeast-2'
        AWS_ACCOUNT_ID = '954382416992'
        
        // --- ECR 정보 ---
        ECR_REPO_NAME = 'spring-petclinic'
        ECR_URI = "${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPO_NAME}"
        IMAGE_TAG = "spring-petclinic:${BUILD_NUMBER}"
        FULL_IMAGE_URI = "${ECR_URI}:${BUILD_NUMBER}"

        // --- ECS 배포 정보 ---
        ECS_CLUSTER_NAME = 'Daegok-Cluster'
        ECS_SERVICE_NAME = 'Daegok-Cluster-Service'
        TASK_FAMILY = 'Daegok-Petclinic-task'
        
        TASK_DEF_FILE = 'task-definition.json'
        CONTAINER_NAME = 'web'
        
        // --- CodeDeploy 정보 ---
        CODE_DEPLOY_APP_NAME = 'Daegok-CodeDeploy'
        CODE_DEPLOY_GROUP_NAME = 'Daegok-CodeDeploy'
        
        DEPLOYMENT_CONFIG = 'CodeDeployDefault.ECSLinear10PercentEvery1Minutes'
    }

    stages {
        stage('Checkout & Create Configs') {
            steps {
                script {
                    deleteDir()
                    sh 'git clone -b main https://github.com/spring-projects/spring-petclinic.git .'

                    // 1. pom.xml 생성
                    sh '''
                    cat > pom.xml <<'EOF'
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>4.0.0-M3</version>
        <relativePath></relativePath>
    </parent>
    <groupId>org.springframework.samples</groupId>
    <artifactId>spring-petclinic</artifactId>
    <version>4.0.0-SNAPSHOT</version>
    <name>petclinic</name>
    <properties>
        <java.version>21</java.version> <maven.compiler.release>21</maven.compiler.release>
        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
        <project.reporting.outputEncoding>UTF-8</project.reporting.outputEncoding>
        <project.build.outputTimestamp>2024-11-28T14:37:52Z</project.build.outputTimestamp>
        <webjars-locator.version>1.1.1</webjars-locator.version>
        <webjars-bootstrap.version>5.3.8</webjars-bootstrap.version>
        <webjars-font-awesome.version>4.7.0</webjars-font-awesome.version>
        <checkstyle.version>11.1.0</checkstyle.version>
        <error-prone.version>2.42.0</error-prone.version>
        <jacoco.version>0.8.13</jacoco.version>
        <libsass.version>0.3.4</libsass.version>
        <lifecycle-mapping>1.0.0</lifecycle-mapping>
        <maven-checkstyle.version>3.6.0</maven-checkstyle.version>
        <nohttp-checkstyle.version>0.0.11</nohttp-checkstyle.version>
        <nullaway.version>0.12.10</nullaway.version>
        <spring-format.version>0.0.47</spring-format.version>
    </properties>
    <dependencies>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-actuator</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-cache</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-data-jpa</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-validation</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-thymeleaf</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-restclient</artifactId>
            <scope>test</scope>
        </dependency>
        <dependency>
            <groupId>com.h2database</groupId>
            <artifactId>h2</artifactId>
            <scope>runtime</scope>
        </dependency>
        <dependency>
            <groupId>com.mysql</groupId>
            <artifactId>mysql-connector-j</artifactId>
            <scope>runtime</scope>
        </dependency>
        <dependency>
            <groupId>org.postgresql</groupId>
            <artifactId>postgresql</artifactId>
            <scope>runtime</scope>
        </dependency>
        <dependency>
            <groupId>javax.cache</groupId>
            <artifactId>cache-api</artifactId>
        </dependency>
        <dependency>
            <groupId>com.github.ben-manes.caffeine</groupId>
            <artifactId>caffeine</artifactId>
        </dependency>
        <dependency>
            <groupId>org.webjars</groupId>
            <artifactId>webjars-locator-lite</artifactId>
            <version>${webjars-locator.version}</version>
        </dependency>
        <dependency>
            <groupId>org.webjars.npm</groupId>
            <artifactId>bootstrap</artifactId>
            <version>${webjars-bootstrap.version}</version>
        </dependency>
        <dependency>
            <groupId>org.webjars.npm</groupId>
            <artifactId>font-awesome</artifactId>
            <version>${webjars-font-awesome.version}</version>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-devtools</artifactId>
            <scope>test</scope>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-testcontainers</artifactId>
            <scope>test</scope>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-docker-compose</artifactId>
            <scope>test</scope>
        </dependency>
        <dependency>
            <groupId>org.testcontainers</groupId>
            <artifactId>junit-jupiter</artifactId>
            <scope>test</scope>
        </dependency>
        <dependency>
            <groupId>org.testcontainers</groupId>
            <artifactId>mysql</artifactId>
            <scope>test</scope>
        </dependency>
        <dependency>
            <groupId>jakarta.xml.bind</groupId>
            <artifactId>jakarta.xml.bind-api</artifactId>
        </dependency>
    </dependencies>
    <build>
        <plugins>
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-enforcer-plugin</artifactId>
                <executions>
                    <execution>
                        <id>enforce-java</id>
                        <goals>
                            <goal>enforce</goal>
                        </goals>
                        <configuration>
                            <rules>
                                <requireJavaVersion>
                                    <message>This build requires at least Java ${java.version}, update your JVM, and run the build again</message>
                                    <version>${java.version}</version>
                                </requireJavaVersion>
                            </rules>
                        </configuration>
                    </execution>
                </executions>
            </plugin>
            <plugin>
                <groupId>io.spring.javaformat</groupId>
                <artifactId>spring-javaformat-maven-plugin</artifactId>
                <version>${spring-format.version}</version>
                <executions>
                    <execution>
                        <goals>
                            <goal>validate</goal>
                        </goals>
                        <phase>validate</phase>
                    </execution>
                </executions>
            </plugin>
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-checkstyle-plugin</artifactId>
                <version>${maven-checkstyle.version}</version>
                <dependencies>
                    <dependency>
                        <groupId>com.puppycrawl.tools</groupId>
                        <artifactId>checkstyle</artifactId>
                        <version>${checkstyle.version}</version>
                    </dependency>
                    <dependency>
                        <groupId>io.spring.nohttp</groupId>
                        <artifactId>nohttp-checkstyle</artifactId>
                        <version>${nohttp-checkstyle.version}</version>
                    </dependency>
                </dependencies>
                <executions>
                    <execution>
                        <id>nohttp-checkstyle-validation</id>
                        <goals>
                            <goal>check</goal>
                        </goals>
                        <phase>validate</phase>
                        <configuration>
                            <configLocation>src/checkstyle/nohttp-checkstyle.xml</configLocation>
                            <sourceDirectories>${basedir}</sourceDirectories>
                            <includes>**/*</includes>
                            <excludes>**/.git/**/*,**/.idea/**/*,**/target/**/,**/.flattened-pom.xml,**/*.class</excludes>
                            <propertyExpansion>config_loc=${basedir}/src/checkstyle/</propertyExpansion>
                        </configuration>
                    </execution>
                </executions>
            </plugin>
            <plugin>
                <groupId>org.graalvm.buildtools</groupId>
                <artifactId>native-maven-plugin</artifactId>
            </plugin>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
                <executions>
                    <execution>
                        <goals>
                            <goal>build-info</goal>
                        </goals>
                        <configuration>
                            <additionalProperties>
                                <encoding.source>${project.build.sourceEncoding}</encoding.source>
                                <encoding.reporting>${project.reporting.outputEncoding}</encoding.reporting>
                                <java.source>${java.version}</java.source>
                                <java.target>${java.version}</java.target>
                            </additionalProperties>
                        </configuration>
                    </execution>
                </executions>
            </plugin>
            <plugin>
                <groupId>org.jacoco</groupId>
                <artifactId>jacoco-maven-plugin</artifactId>
                <version>${jacoco.version}</version>
                <executions>
                    <execution>
                        <goals>
                            <goal>prepare-agent</goal>
                        </goals>
                    </execution>
                    <execution>
                        <id>report</id>
                        <goals>
                            <goal>report</goal>
                        </goals>
                        <phase>prepare-package</phase>
                    </execution>
                </executions>
            </plugin>
            <plugin>
                <groupId>io.github.git-commit-id</groupId>
                <artifactId>git-commit-id-maven-plugin</artifactId>
                <configuration>
                    <failOnNoGitDirectory>false</failOnNoGitDirectory>
                    <failOnUnableToExtractRepoInfo>false</failOnUnableToExtractRepoInfo>
                </configuration>
            </plugin>
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-compiler-plugin</artifactId>
                <executions>
                    <execution>
                        <id>default-compile</id>
                        <phase>compile</phase>
                        <goals>
                            <goal>compile</goal>
                        </goals>
                        <configuration>
                            <compilerArgs>
                                <arg>-XDcompilePolicy=simple</arg>
                                <arg>--should-stop=ifError=FLOW</arg>
                                <arg>-Xplugin:ErrorProne -XepDisableAllChecks -Xep:NullAway:ERROR -XepOpt:NullAway:OnlyNullMarked=true -XepOpt:NullAway:CustomContractAnnotations=org.springframework.lang.Contract -XepOpt:NullAway:JSpecifyMode=true</arg>
                            </compilerArgs>
                            <annotationProcessorPaths>
                                <path>
                                    <groupId>com.google.errorprone</groupId>
                                    <artifactId>error_prone_core</artifactId>
                                    <version>${error-prone.version}</version>
                                </path>
                                <path>
                                    <groupId>com.uber.nullaway</groupId>
                                    <artifactId>nullaway</artifactId>
                                    <version>${nullaway.version}</version>
                                </path>
                            </annotationProcessorPaths>
                        </configuration>
                    </execution>
                </executions>
            </plugin>
            <plugin>
                <?m2e ignore?>
                <groupId>org.cyclonedx</groupId>
                <artifactId>cyclonedx-maven-plugin</artifactId>
            </plugin>
        </plugins>
    </build>
    <licenses>
        <license>
            <name>Apache License, Version 2.0</name>
            <url>https://www.apache.org/licenses/LICENSE-2.0</url>
        </license>
    </licenses>
    <profiles>
        <profile>
            <id>css</id>
            <build>
                <plugins>
                    <plugin>
                        <groupId>org.apache.maven.plugins</groupId>
                        <artifactId>maven-dependency-plugin</artifactId>
                        <executions>
                            <execution>
                                <id>unpack</id>
                                <goals>
                                    <goal>unpack</goal>
                                </goals>
                                <?m2e execute onConfiguration,onincremental?>
                                <phase>generate-resources</phase>
                                <configuration>
                                    <artifactItems>
                                        <artifactItem>
                                            <groupId>org.webjars.npm</groupId>
                                            <artifactId>bootstrap</artifactId>
                                            <version>${webjars-bootstrap.version}</version>
                                        </artifactItem>
                                    </artifactItems>
                                    <outputDirectory>${project.build.directory}/webjars</outputDirectory>
                                </configuration>
                            </execution>
                        </executions>
                    </plugin>
                    <plugin>
                        <groupId>com.gitlab.haynes</groupId>
                        <artifactId>libsass-maven-plugin</artifactId>
                        <version>${libsass.version}</version>
                        <configuration>
                            <inputPath>${basedir}/src/main/scss/</inputPath>
                            <outputPath>${basedir}/src/main/resources/static/resources/css/</outputPath>
                            <includePath>${project.build.directory}/webjars/META-INF/resources/webjars/bootstrap/${webjars-bootstrap.version}/scss/</includePath>
                        </configuration>
                        <executions>
                            <execution>
                                <?m2e execute onConfiguration,onincremental?>
                                <goals>
                                    <goal>compile</goal>
                                </goals>
                                <phase>generate-resources</phase>
                            </execution>
                        </executions>
                    </plugin>
                </plugins>
            </build>
        </profile>
        <profile>
            <id>m2e</id>
            <activation>
                <property>
                    <name>m2e.version</name>
                </property>
            </activation>
            <build>
                <pluginManagement>
                    <plugins>
                        <plugin>
                            <groupId>org.eclipse.m2e</groupId>
                            <artifactId>lifecycle-mapping</artifactId>
                            <version>${lifecycle-mapping}</version>
                            <configuration>
                                <lifecycleMappingMetadata>
                                    <pluginExecutions>
                                        <pluginExecution>
                                            <pluginExecutionFilter>
                                                <groupId>org.apache.maven.plugins</groupId>
                                                <artifactId>maven-checkstyle-plugin</artifactId>
                                                <versionRange>[1,)</versionRange>
                                                <goals>
                                                    <goal>check</goal>
                                                </goals>
                                            </pluginExecutionFilter>
                                            <action>
                                                <ignore></ignore>
                                            </action>
                                        </pluginExecution>
                                        <pluginExecution>
                                            <pluginExecutionFilter>
                                                <groupId>org.springframework.boot</groupId>
                                                <artifactId>spring-boot-maven-plugin</artifactId>
                                                <versionRange>[1,)</versionRange>
                                                <goals>
                                                    <goal>build-info</goal>
                                                </goals>
                                            </pluginExecutionFilter>
                                            <action>
                                                <ignore></ignore>
                                            </action>
                                        </pluginExecution>
                                        <pluginExecution>
                                            <pluginExecutionFilter>
                                                <groupId>io.spring.javaformat</groupId>
                                                <artifactId>spring-javaformat-maven-plugin</artifactId>
                                                <versionRange>[0,)</versionRange>
                                                <goals>
                                                    <goal>validate</goal>
                                                </goals>
                                            </pluginExecutionFilter>
                                            <action>
                                                <ignore></ignore>
                                            </action>
                                        </pluginExecution>
                                    </pluginExecutions>
                                </lifecycleMappingMetadata>
                            </configuration>
                        </plugin>
                    </plugins>
                </pluginManagement>
            </build>
        </profile>
    </profiles>
</project>
EOF
                    '''
                    // 2. Dockerfile 생성 
                    sh '''
                    cat > Dockerfile <<'EOF'
FROM maven:3.9.6-eclipse-temurin-21 AS builder
WORKDIR /app
COPY pom.xml .
RUN mvn dependency:go-offline
COPY . .
RUN mvn clean package -DskipTests

FROM eclipse-temurin:21-jdk
WORKDIR /app
COPY --from=builder /app/target/*.jar app.jar
EXPOSE 8080
ENTRYPOINT ["java", "-jar", "app.jar"]
EOF
                    '''
                    sh 'ls -l Dockerfile'

                    // 3. Task Definition 템플릿 파일 생성
                    sh """
                    cat > ${TASK_DEF_FILE} <<'EOF'
{
    "family": "${TASK_FAMILY}",
    "networkMode": "awsvpc",
    "containerDefinitions": [
        {
            "cpu": 0,
            "environment": [],
            "environmentFiles": [],
            "essential": true,
            "image": "placeholder-image-uri:latest",
            "logConfiguration": {
                "logDriver": "awslogs",
                "options": {
                    "awslogs-group": "/ecs/Daegok-Petclinic-task",
                    "awslogs-create-group": "true",
                    "awslogs-region": "ap-northeast-2",
                    "awslogs-stream-prefix": "ecs"
                },
                "secretOptions": []
            },
            "mountPoints": [],
            "name": "${CONTAINER_NAME}",
            "portMappings": [
                {
                    "appProtocol": "http",
                    "containerPort": 8080,
                    "hostPort": 8080,
                    "name": "web-8080-tcp",
                    "protocol": "tcp"
                }
            ],
            "systemControls": [],
            "ulimits": [],
            "volumesFrom": []
        }
    ],
    "cpu": "1024",
    "enableFaultInjection": false,
    "executionRoleArn": "arn:aws:iam::${AWS_ACCOUNT_ID}:role/ecsTaskExecutionRole",
    "memory": "3072",
    "placementConstraints": [],
    "requiresCompatibilities": [
        "FARGATE"
    ],
    "runtimePlatform": {
        "cpuArchitecture": "X86_64",
        "operatingSystemFamily": "LINUX"
    },
    "volumes": [],
    "tags": []
}
EOF
                    """
                }
            }
        }

        stage('Build Docker Image') {
            steps {
                script {
                    sh 'echo "Building Docker image..."'
                    sh 'docker build --network=host -t $IMAGE_TAG -f Dockerfile .'
                }
            }
        }

        stage('Login to AWS ECR') {
            steps {
                script {
                    sh 'echo "Logging into AWS ECR..."'
                    sh 'aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $ECR_URI'
                }
            }
        }

        stage('Tag and Push Image to ECR') {
            steps {
                script {
                    sh 'echo "Tagging and pushing image to ECR..."'
                    sh 'docker tag $IMAGE_TAG $FULL_IMAGE_URI'
                    sh 'docker push $FULL_IMAGE_URI'
                    sh 'echo "Image URI: $FULL_IMAGE_URI"'
                }
            }
        }
        
        stage('Prepare Task Definition') {
            steps {
                script {
                    sh """
                    echo "Updating Task Definition with new image URI: $FULL_IMAGE_URI"

                    cat ${TASK_DEF_FILE} | \\
                    jq --arg image_uri "$FULL_IMAGE_URI" '
                                .containerDefinitions |= map(
                                    if .name == "${CONTAINER_NAME}" then
                                        .image = \$image_uri
                                    else
                                        .
                                    end
                                    )
                                ' > ${TASK_DEF_FILE}_NEW
                    
                    mv ${TASK_DEF_FILE}_NEW ${TASK_DEF_FILE}
                    
                    echo "--- Final Updated Task Definition ---"
                    cat ${TASK_DEF_FILE}
                    echo "-----------------------------------"
                    """
                }
            }
        }
        
        stage('Install yq') {
            steps {
                sh '''
                    echo "Installing yq in the local workspace directory..."
                    
                    # 1. 현재 작업 디렉토리(\$PWD)에 yq 다운로드 (curl)
                    curl -L https://github.com/mikefarah/yq/releases/download/v4.44.2/yq_linux_amd64 -o yq
                    
                    # 2. 실행 권한 부여
                    chmod +x yq
                    
                    # 3. yq 실행을 위해 현재 디렉토리(\$PWD)를 \$PATH에 추가 (이 설정은 이 sh 블록 내에서만 유효)
                    export PATH=$PWD:$PATH
                    
                    echo "yq version:"
                    yq --version
                    '''
            }
        }

        stage('Deploy to ECS with CodeDeploy') {
            steps {
                script {
                    // Task Definition 등록
                    sh("""
                        export PATH=\$PWD:\$PATH
                        echo "PATH updated for this script block."
                        
                        echo "Registering new Task Definition..."
                        
                        CLEAN_TASK_DEF_FILE="task-definition-clean.json"
                        
                        # 1. Task Definition JSON에서 불필요한 필드 제거 및 정리
                        cat \${TASK_DEF_FILE} | \\
                            jq 'del(.taskDefinitionArn) | del(.revision) | del(.status) | del(.registeredAt) | del(.registeredBy) | del(.requiresAttributes) | del(.compatibilities) | del(.tags) | del(.enableFaultInjection)' > \${CLEAN_TASK_DEF_FILE}

                        # 2. 새로운 Task Definition 등록 및 ARN 가져오기
                        NEW_TASK_ARN=\$(aws ecs register-task-definition --cli-input-json file://\${CLEAN_TASK_DEF_FILE} --region ${env.AWS_REGION} | jq -r '.taskDefinition.taskDefinitionArn // empty')

                        if [ -z "\${NEW_TASK_ARN}" ]; then
                            echo "ERROR: Failed to register new Task Definition."
                            exit 1
                        fi
                        
                        echo "New Task Definition ARN: \${NEW_TASK_ARN}"
                        echo "\${NEW_TASK_ARN}"
                    """)

                    // ARN을 Groovy 변수에 저장
                    def newTaskArn = sh(
                        script: "export PATH=\$PWD:\$PATH; aws ecs describe-task-definition --task-definition ${TASK_FAMILY} --region ${env.AWS_REGION} | jq -r '.taskDefinition.taskDefinitionArn'",
                        returnStdout: true
                    ).trim()
                    
                    // 3. AppSpec YAML 파일 내용 생성
                    def appSpecContent = """
version: 0.0
Resources:
  - TargetService:
      Type: AWS::ECS::Service
      Properties:
        TaskDefinition: "${newTaskArn}"
        LoadBalancerInfo:
          ContainerName: "${CONTAINER_NAME}"
          ContainerPort: 8080
        PlatformVersion: "LATEST"
"""
                    // 4. AppSpec YAML을 파일로 작성
                    writeFile file: 'appspec.yml', text: appSpecContent
                    
                    sh 'echo "--- Generated AppSpec YAML ---"; cat appspec.yml; echo "----------------------------"'
                    
                    // 5. CodeDeploy 배포 실행
                    sh("""
                        export PATH=\$PWD:\$PATH

                        echo "Starting CodeDeploy deployment using config: ${DEPLOYMENT_CONFIG}..."
                        
                        # yq를 사용하여 YAML 파일을 깨끗한 JSON 문자열로 변환
                        APP_SPEC_JSON=\$(yq -o=json appspec.yml)
                        
                        echo "AppSpec JSON Content: \${APP_SPEC_JSON}"
                        
                        # AWS CLI 명령: CodeDeploy 배포 요청 (ID 획득)
                        DEPLOYMENT_ID=\$(aws deploy create-deployment \\
                            --application-name "${CODE_DEPLOY_APP_NAME}" \\
                            --deployment-group-name "${CODE_DEPLOY_GROUP_NAME}" \\
                            --deployment-config-name "${DEPLOYMENT_CONFIG}" \\
                            --revision "\$(echo '{"revisionType": "AppSpecContent", "appSpecContent": {"content": '\${APP_SPEC_JSON}'}}' | jq -c '.appSpecContent.content |= @json')" \\
                            --region "${AWS_REGION}" \\
                            | jq -r '.deploymentId // empty')
                            
                        if [ -z "\${DEPLOYMENT_ID}" ]; then
                            echo "ERROR: Failed to trigger CodeDeploy deployment."
                            exit 1
                        fi
                        
                        echo "======================================================================"
                        echo " CodeDeploy 배포 요청 성공. ID: \${DEPLOYMENT_ID}"
                        echo " Jenkins 잡은 여기서 성공으로 종료됩니다."
                        echo "실제 배포는 AWS에서 백그라운드로 진행됩니다."
                        echo "======================================================================"
                        
                        #  이전 요청에 따라 'aws deploy wait deployment-successful' 명령을 제거했습니다.
                    """)
                }
            }
        }
    }

    post {
        success {
            echo 'Build, push, and CodeDeploy deployment initiation succeeded!'
            echo '실제 AWS 배포 진행 상황은 CodeDeploy 콘솔에서 확인하세요.'
        }
        failure {
            echo 'Build, push, 또는 CodeDeploy 배포 요청 단계에서 오류가 발생했습니다. 로그를 확인하세요.'
        }
    }
}